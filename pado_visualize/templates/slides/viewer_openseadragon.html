{% extends "layout.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='slides_openseadragon.css') }}">
{% endblock styles %}

{% block scripts_header %}
{% endblock scripts_header %}

{% block content %}
<div class="seadragon-container-parent">
    <div id="progress-overlay"><div class="progress-container"><div class="progress"></div></div></div>
    <div id="seadragon-container" ></div>
</div>
{% endblock content %}


{% macro menu_select(text, id_, checked=false, data=none) -%}
  <li class="menu-item">
    <input
        id="{{ id_ }}"
        type="checkbox"
        {% if checked %}checked{% endif %}
        {% if data %}
          {% for k, v in data.items() %}
            {{ 'data-{}={}'.format(k, v) }}
          {% endfor %}
        {% endif %}
    />
    <label for="{{ id_ }}">{{ text|escape }}</label>
  </li>
{% endmacro %}

{% block post_menu %}
  <ul class="menu" style="padding-top: 20px;">
    {% if has_annotations %}
      {{ menu_select("annotations", "checkbox-annotations", checked=show_annotations) }}
    {% endif %}
  </ul>
{% endblock post_menu %}


{% block page_scripts %}
<script type="text/javascript" src="{{ url_for('static', filename='slides_openseadragon.js') }}"></script>
<script type="text/javascript">
    'use strict';
    // image predictions
    const hasAnnotations = Boolean({{ has_annotations|tojson }});

    // image url
    const tileSources = [{
        tileSource: "{{ url_for('slides.slide_dzi', image_id=image_id) }}",
    }];

    // connect checkboxes
    if (hasAnnotations) {
      const cbxAnnotations = document.querySelector("input[id=checkbox-annotations]");
      cbxAnnotations.addEventListener('change', function() {
          pavo.slides_openseadragon.setAnnotationVisibility("seadragon-container", this.checked);
      });
    }

    // progress bar
    const progressUrl = "{{ url_for('slides.cache_status', image_id=image_id) }}";
    const progressBar = document.querySelector(".progress");
    const progressOverlay = document.querySelector("#progress-overlay");
    const changeProgress = () => {
      fetch(progressUrl).then(res => res.json()).then(out => {
          let progress;
          if (out.ready) {
              progress = 100;
          } else if (out.progress > 0) {
              progress = Math.min(out.progress, 100);
          } else {
              progress = 0;
          }
          progressBar.style.width = `${progress}%`;
          if (progress < 100) {
              setTimeout(changeProgress, 200);
          }
          else {
            setTimeout(() => {progressOverlay.style.display = "none"}, 1000);
          }
      }).catch(err => {throw err});
    };
    changeProgress();

    // setup the slide viewer
    pavo.slides_openseadragon.setupOpenSeadragonViewer({
        id: "seadragon-container",
        tileSources: tileSources,
        prefixUrl: "{{ url_for('static', filename='images/openseadragon/') }}",
    },{
        annotationUrl: "{{ url_for('slides.serve_w3c_annotations', image_id=image_id) }}",
    });

</script>
{% endblock %}
